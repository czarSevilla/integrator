# playbook.yml
---
- name: Compilar imagenes para despliegue en Docker Compose
  hosts: localhost
  connection: local
  gather_facts: no

  tasks:
    - name: Create dist directory
      ansible.builtin.file:
        path: "{{ DIST_PATH }}"
        state: directory
        mode: "0755"

    - name: Parametrizar script de inicialización del tablespace
      ansible.builtin.template:
        src: "{{ DB_POSTGRES_PATH_BUILD }}/00-init-tablespace.sh"
        dest: "{{ DIST_PATH }}/00-init-tablespace.sh"
        mode: "0755"
        attributes:
          DB_KEYCLOAK_TABLESPACE_LOCATION: "{{ DB_KEYCLOAK_TABLESPACE_LOCATION }}"

    - name: Parametrizar init-db.sql
      ansible.builtin.template:
        src: "{{ DB_POSTGRES_PATH_BUILD }}/init-db.sql"
        dest: "{{ DIST_PATH }}/init-db.sql"
        mode: "0644"
        attributes:
          DB_KEYCLOAK_TABLESPACE_LOCATION: "{{ DB_KEYCLOAK_TABLESPACE_LOCATION }}"
          DB_KEYCLOAK_USER: "{{ DB_KEYCLOAK_USER }}"
          DB_KEYCLOAK_PASSWORD: "{{ DB_KEYCLOAK_PASSWORD }}"
          DB_KEYCLOAK_NAME: "{{ DB_KEYCLOAK_NAME }}"

    - name: Parametrizar docker-compose.yml
      ansible.builtin.template:
        src: "docker-compose.yml"
        dest: "{{ DIST_PATH }}/docker-compose.yml"
        mode: "0644"
        attributes:
          DB_KEYCLOAK_TABLESPACE_LOCATION: "{{ DB_KEYCLOAK_TABLESPACE_LOCATION }}"
          DB_ROOT_PASSWORD: "{{ DB_ROOT_PASSWORD }}"
          DB_ROOT_USER: "{{ DB_ROOT_USER }}"
          DB_NAME: "{{ DB_NAME }}"
          TIMEZONE: "{{ TIMEZONE }}"
          APP_POSTGRES_NAME: "{{ APP_POSTGRES_NAME }}"
          APP_POSTGRES_VERSION: "{{ APP_POSTGRES_VERSION }}"
          KEYCLOAK_ADMIN: "{{ KEYCLOAK_ADMIN }}"
          KEYCLOAK_ADMIN_PASSWORD: "{{ KEYCLOAK_ADMIN_PASSWORD }}"
          DB_KEYCLOAK_USER: "{{ DB_KEYCLOAK_USER }}"
          DB_KEYCLOAK_PASSWORD: "{{ DB_KEYCLOAK_PASSWORD }}"
          DB_KEYCLOAK_NAME: "{{ DB_KEYCLOAK_NAME }}"
    
    - name: Verificar que los archivos de inicialización estén presentes
      ansible.builtin.debug:
        msg: "Archivos de inicialización generados en {{ DIST_PATH }}"
    
    - name: Compilar imagen de PostgreSQL con locales
      community.docker.docker_image:
        name: "{{ APP_POSTGRES_NAME }}:{{ APP_POSTGRES_VERSION }}"
        build:
          path: "{{ DB_POSTGRES_PATH_BUILD }}"
        source: build
        state: present
      register: postgres_image_build_result
    
    - name: Verificar el resultado de la compilación de PostgreSQL
      ansible.builtin.debug:
        msg: "Imagen {{ APP_POSTGRES_NAME }}:{{ APP_POSTGRES_VERSION }} construida. ID: {{ postgres_image_build_result.image.Id }}"
    
    - name: Compilar imagen de Identity Manager
      community.docker.docker_image:
        name: "{{ APP_IDENTITY_MANAGER_NAME }}:{{ APP_IDENTITY_MANAGER_VERSION }}"
        build:
          path: "{{ IDENTITY_MANAGER_PATH_BUILD }}"
        source: build
        state: present
      register: image_build_result
    
    - name: Verificar el resultado de la compilación
      ansible.builtin.debug:
        msg: "Imagen {{ APP_IDENTITY_MANAGER_NAME }}:{{ APP_IDENTITY_MANAGER_VERSION }} construida. ID: {{ image_build_result.image.Id }}"
    