# playbook.yml
---
- name: Compilar imagenes para despliegue en Docker Compose
  hosts: localhost
  connection: local
  gather_facts: no

  tasks:
    - name: Create dist directory
      ansible.builtin.file:
        path: "{{ DIST_PATH }}"
        state: directory
        mode: "0755"

    - name: Parametrizar script de inicialización del tablespace de keycloak
      ansible.builtin.template:
        src: "{{ DB_POSTGRES_PATH_BUILD }}/00-init-tablespace.sh"
        dest: "{{ DIST_PATH }}/00-init-tablespace.sh"
        mode: "0755"
    
    - name: Parametrizar script de inicialización del tablespace de app
      ansible.builtin.template:
        src: "{{ DB_POSTGRES_PATH_BUILD }}/01-init-tablespace.sh"
        dest: "{{ DIST_PATH }}/01-init-tablespace.sh"
        mode: "0755"

    - name: Parametrizar 02-init-db.sql
      ansible.builtin.template:
        src: "{{ DB_POSTGRES_PATH_BUILD }}/init-db.sql"
        dest: "{{ DIST_PATH }}/02-init-db.sql"
        mode: "0644"
    
    - name: Parametrizar 03-init-db.sql
      ansible.builtin.template:
        src: "{{ DB_INIT_DB_SQL_PATH }}/050_ddl_catalogos.sql"
        dest: "{{ DIST_PATH }}/03-init-db.sql"
        mode: "0644"
    
    - name: Parametrizar 04-init-db.sql
      ansible.builtin.template:
        src: "{{ DB_INIT_DB_SQL_PATH }}/051_data_catalogos.sql"
        dest: "{{ DIST_PATH }}/04-init-db.sql"
        mode: "0644"
    
    - name: Parametrizar 05-init-db.sql
      ansible.builtin.template:
        src: "{{ DB_INIT_DB_SQL_PATH }}/060_ddl_clientes.sql"
        dest: "{{ DIST_PATH }}/05-init-db.sql"
        mode: "0644"
    
    - name: Parametrizar 06-init-db.sql
      ansible.builtin.template:
        src: "{{ DB_INIT_DB_SQL_PATH }}/070_ddl_dispositivos_tec.sql"
        dest: "{{ DIST_PATH }}/06-init-db.sql"
        mode: "0644"
    
    - name: Agregar instrucción \c al principio de 03-init-db.sql
      ansible.builtin.lineinfile:
        path: "{{ DIST_PATH }}/03-init-db.sql"
        line: "\\c {{ DB_APP_NAME }}"
        insertbefore: BOF

    - name: Agregar instrucción \c al principio de 04-init-db.sql
      ansible.builtin.lineinfile:
        path: "{{ DIST_PATH }}/04-init-db.sql"
        line: "\\c {{ DB_APP_NAME }}"
        insertbefore: BOF
        
    - name: Agregar instrucción \c al principio de 05-init-db.sql
      ansible.builtin.lineinfile:
        path: "{{ DIST_PATH }}/05-init-db.sql"
        line: "\\c {{ DB_APP_NAME }}"
        insertbefore: BOF

    - name: Agregar instrucción \c al principio de 06-init-db.sql
      ansible.builtin.lineinfile:
        path: "{{ DIST_PATH }}/05-init-db.sql"
        line: "\\c {{ DB_APP_NAME }}"
        insertbefore: BOF
        
    - name: Agregar instrucción \c al principio de 06-init-db.sql
      ansible.builtin.lineinfile:
        path: "{{ DIST_PATH }}/06-init-db.sql"
        line: "\\c {{ DB_APP_NAME }}"
        insertbefore: BOF

    - name: Parametrizar docker-compose.yml
      ansible.builtin.template:
        src: "docker-compose.yml"
        dest: "{{ DIST_PATH }}/docker-compose.yml"
        mode: "0644"
    
    - name: Verificar que los archivos de inicialización estén presentes
      ansible.builtin.debug:
        msg: "Archivos de inicialización generados en {{ DIST_PATH }}"
    
    - name: Compilar imagen de PostgreSQL con locales
      community.docker.docker_image:
        name: "{{ POSTGRES_IMAGE_NAME }}"
        build:
          path: "{{ DB_POSTGRES_PATH_BUILD }}"
        source: build
        state: present
      register: postgres_image_build_result
    
    - name: Verificar el resultado de la compilación de PostgreSQL
      ansible.builtin.debug:
        msg: "Imagen {{ POSTGRES_IMAGE_NAME }} construida. ID: {{ postgres_image_build_result.image.Id }}"
    
    - name: Copiar tema de Keycloak
      ansible.builtin.copy:
        src: "{{ IDENTITY_MANAGER_THEME_SRC }}/login"
        dest: "{{ IDENTITY_MANAGER_PATH_BUILD }}/ps-theme"
        mode: "0644"
    
    - name: Compilar imagen de Identity Manager
      community.docker.docker_image:
        name: "{{ IDENTITY_MANAGER_IMAGE_NAME }}"
        build:
          path: "{{ IDENTITY_MANAGER_PATH_BUILD }}"
        source: build
        state: present
      register: image_build_result
    
    - name: Verificar el resultado de la compilación
      ansible.builtin.debug:
        msg: "Imagen {{ IDENTITY_MANAGER_IMAGE_NAME }} construida. ID: {{ image_build_result.image.Id }}"
    
    - name: Copiar certificados
      ansible.builtin.copy:
        src: "{{ REVERSE_PROXY_PATH_BUILD }}/certs"
        dest: "{{ DIST_PATH }}"
        mode: "0644"
    
    - name: Copiar dynamic_configs
      ansible.builtin.copy:
        src: "{{ REVERSE_PROXY_PATH_BUILD }}/dynamic_configs"
        dest: "{{ DIST_PATH }}"
        mode: "0644"
    
