# playbook.yml
---
- name: Compilar imagenes para despliegue en Docker Compose
  hosts: localhost
  connection: local
  gather_facts: no

  tasks:
    - name: Create dist directory
      ansible.builtin.file:
        path: "{{ DIST_PATH }}"
        state: directory
        mode: "0755"

    - name: Parametrizar script de inicialización del tablespace de keycloak
      ansible.builtin.template:
        src: "{{ DB_POSTGRES_PATH_BUILD }}/00-init-tablespace.sh"
        dest: "{{ DIST_PATH }}/00-init-tablespace.sh"
        mode: "0755"
    
    - name: Parametrizar script de inicialización del tablespace de app
      ansible.builtin.template:
        src: "{{ DB_POSTGRES_PATH_BUILD }}/01-init-tablespace.sh"
        dest: "{{ DIST_PATH }}/01-init-tablespace.sh"
        mode: "0755"

    - name: Parametrizar init-db.sql
      ansible.builtin.template:
        src: "{{ DB_POSTGRES_PATH_BUILD }}/init-db.sql"
        dest: "{{ DIST_PATH }}/init-db.sql"
        mode: "0644"

    - name: Parametrizar docker-compose.yml
      ansible.builtin.template:
        src: "docker-compose.yml"
        dest: "{{ DIST_PATH }}/docker-compose.yml"
        mode: "0644"
    
    - name: Verificar que los archivos de inicialización estén presentes
      ansible.builtin.debug:
        msg: "Archivos de inicialización generados en {{ DIST_PATH }}"
    
    - name: Compilar imagen de PostgreSQL con locales
      community.docker.docker_image:
        name: "{{ POSTGRES_IMAGE_NAME }}"
        build:
          path: "{{ DB_POSTGRES_PATH_BUILD }}"
        source: build
        state: present
      register: postgres_image_build_result
    
    - name: Verificar el resultado de la compilación de PostgreSQL
      ansible.builtin.debug:
        msg: "Imagen {{ POSTGRES_IMAGE_NAME }} construida. ID: {{ postgres_image_build_result.image.Id }}"
    
    - name: Compilar imagen de Identity Manager
      community.docker.docker_image:
        name: "{{ IDENTITY_MANAGER_IMAGE_NAME }}"
        build:
          path: "{{ IDENTITY_MANAGER_PATH_BUILD }}"
        source: build
        state: present
      register: image_build_result
    
    - name: Verificar el resultado de la compilación
      ansible.builtin.debug:
        msg: "Imagen {{ IDENTITY_MANAGER_IMAGE_NAME }} construida. ID: {{ image_build_result.image.Id }}"
    
    - name: Copiar certificados
      ansible.builtin.copy:
        src: "{{ REVERSE_PROXY_PATH_BUILD }}/certs"
        dest: "{{ DIST_PATH }}"
        mode: "0644"
    
    - name: Copiar dynamic_configs
      ansible.builtin.copy:
        src: "{{ REVERSE_PROXY_PATH_BUILD }}/dynamic_configs"
        dest: "{{ DIST_PATH }}"
        mode: "0644"
    
